<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enroll Now | Courage Library</title>
  <link rel="icon" type="image/png" href="/images/logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body class="bg-gray-50 text-gray-900 flex flex-col min-h-screen">

  <!-- Navbar -->
  <nav class="bg-white/90 backdrop-blur-lg shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <a class="flex items-center space-x-2" href="index.html">
        <img src="/images/logo.png" alt="Logo" class="w-8 h-8">
        <span class="text-3xl font-bold text-blue-700 cursor-pointer">Courage Library</span>
      </a>
      <div class="space-x-6 hidden md:flex items-center">
        <a href="index.html#features" class="hover:text-blue-600">Features</a>
        <a href="index.html#courses" class="hover:text-blue-600">Courses</a>
        <a href="index.html#testimonials" class="hover:text-blue-600">Testimonials</a>
        <a href="Blog/Blog.html" class="hover:text-blue-600">Blog</a>
        <a href="index.html#contact" class="hover:text-blue-600">Contact</a>
        <a href="index.html"
          class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-full shadow hover:scale-110 transition">
          Home
        </a>
      </div>
    </div>
  </nav>

  <!-- Main Section -->
  <main class="flex-grow flex justify-center items-center px-4 py-12">
    <div
      class="bg-white/90 backdrop-blur-xl border border-gray-200 p-8 md:p-10 rounded-2xl shadow-2xl w-full max-w-md text-center">
      <h1 class="text-3xl font-bold text-blue-700 mb-4">Enroll Now</h1>
      <p class="text-gray-600 mb-6 text-sm">Choose your course and complete the details below to begin your journey
        with Courage Library.</p>

      <form id="enrollForm" class="space-y-4 text-left" x-data>

        <!-- Course Dropdown -->
        <div x-data="{ open: false, selected: '' }" class="relative">
          <label class="block text-sm font-medium text-gray-600 mb-1">Select Course<span class="text-blue-600">
              *</span></label>
          <button type="button" @click="open = !open"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-white flex justify-between items-center hover:shadow focus:ring-2 focus:ring-blue-400">
            <span x-text="selected || 'Choose a Course'" class="text-gray-700"></span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
              stroke="currentColor" class="w-4 h-4 text-blue-600 transform" :class="{ 'rotate-180': open }">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div x-show="open" @click.outside="open=false"
            class="absolute mt-2 w-full bg-white border rounded-lg shadow-lg z-10">
            <div @click="selected='SSC CGL'; open=false" class="px-4 py-2 hover:bg-blue-50 cursor-pointer">SSC CGL</div>
            <div @click="selected='SSC MTS'; open=false" class="px-4 py-2 hover:bg-blue-50 cursor-pointer">SSC MTS</div>
            <div @click="selected='SSC GD'; open=false" class="px-4 py-2 hover:bg-blue-50 cursor-pointer">SSC GD</div>
            <div @click="selected='Delhi Police'; open=false" class="px-4 py-2 hover:bg-blue-50 cursor-pointer">Delhi
              Police</div>
          </div>
          <input type="hidden" name="course_name" :value="selected">
        </div>

        <!-- Full Name -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Full Name<span class="text-blue-600">
              *</span></label>
          <input type="text" name="full_name" required
            class="w-full border border-gray-300 p-2 rounded-md focus:ring-2 focus:ring-blue-400">
        </div>

        <!-- Gender Dropdown -->
        <div x-data="{ open: false, selected: '' }" class="relative">
          <label class="block text-sm font-medium text-gray-600 mb-1">Gender<span class="text-blue-600">
              *</span></label>
          <button type="button" @click="open = !open"
            class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-white flex justify-between items-center hover:shadow focus:ring-2 focus:ring-blue-400">
            <span x-text="selected || 'Select Gender'" class="text-gray-700"></span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
              stroke="currentColor" class="w-4 h-4 text-blue-600 transform" :class="{ 'rotate-180': open }">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div x-show="open" @click.outside="open=false"
            class="absolute mt-2 w-full bg-white border rounded-lg shadow-lg z-10">
            <div @click="selected='Male'; open=false" class="px-4 py-2 hover:bg-blue-50 cursor-pointer">Male</div>
            <div @click="selected='Female'; open=false" class="px-4 py-2 hover:bg-blue-50 cursor-pointer">Female</div>
            <div @click="selected='Other'; open=false" class="px-4 py-2 hover:bg-blue-50 cursor-pointer">Other</div>
          </div>
          <input type="hidden" name="gender" :value="selected">
        </div>

        <!-- DOB Dropdown (Day, Month, Year) -->
        <div x-data="{ day:'', month:'', year:'', openDay:false, openMonth:false, openYear:false }">
          <label class="block text-sm font-medium text-gray-600 mb-2">Date of Birth<span class="text-blue-600">
              *</span></label>
          <div class="grid grid-cols-3 gap-2">
            <!-- Day -->
            <div class="relative">
              <button type="button" @click="openDay=!openDay"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white flex justify-between items-center hover:shadow focus:ring-2 focus:ring-blue-400">
                <span x-text="day || 'Day'" class="text-gray-700"></span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                  stroke="currentColor" class="w-4 h-4 text-blue-600 transform" :class="{ 'rotate-180': openDay }">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div x-show="openDay" @click.outside="openDay=false"
                class="absolute mt-2 w-full max-h-40 overflow-y-auto bg-white border rounded-lg shadow-lg z-10">
                <template x-for="d in 31" :key="d">
                  <div @click="day=d;openDay=false" class="px-3 py-1 hover:bg-blue-50 cursor-pointer" x-text="d"></div>
                </template>
              </div>
            </div>

            <!-- Month -->
            <div class="relative">
              <button type="button" @click="openMonth=!openMonth"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white flex justify-between items-center hover:shadow focus:ring-2 focus:ring-blue-400">
                <span x-text="month || 'Month'" class="text-gray-700"></span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                  stroke="currentColor" class="w-4 h-4 text-blue-600 transform" :class="{ 'rotate-180': openMonth }">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div x-show="openMonth" @click.outside="openMonth=false"
                class="absolute mt-2 w-full bg-white border rounded-lg shadow-lg z-10">
                <template x-for="m in ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']"
                  :key="m">
                  <div @click="month=m;openMonth=false" class="px-3 py-1 hover:bg-blue-50 cursor-pointer" x-text="m">
                  </div>
                </template>
              </div>
            </div>

            <!-- Year -->
            <div class="relative">
              <button type="button" @click="openYear=!openYear"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-white flex justify-between items-center hover:shadow focus:ring-2 focus:ring-blue-400">
                <span x-text="year || 'Year'" class="text-gray-700"></span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                  stroke="currentColor" class="w-4 h-4 text-blue-600 transform" :class="{ 'rotate-180': openYear }">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div x-show="openYear" @click.outside="openYear=false"
                class="absolute mt-2 w-full max-h-40 overflow-y-auto bg-white border rounded-lg shadow-lg z-10">
                <template x-for="y in Array.from({length:70},(_,i)=>new Date().getFullYear()-i)" :key="y">
                  <div @click="year=y;openYear=false" class="px-3 py-1 hover:bg-blue-50 cursor-pointer" x-text="y">
                  </div>
                </template>
              </div>
            </div>
          </div>
          <input type="hidden" name="dob" :value="`${day}-${month}-${year}`">
        </div>

        <!-- Phone -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Phone Number<span class="text-blue-600">
              *</span></label>
          <input type="text" name="phone" required
            class="w-full border border-gray-300 p-2 rounded-md focus:ring-2 focus:ring-blue-400">
        </div>

        <!-- Qualification -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Qualification<span class="text-blue-600">
              *</span></label>
          <input type="text" name="qualification" required
            class="w-full border border-gray-300 p-2 rounded-md focus:ring-2 focus:ring-blue-400">
        </div>

        <!-- Address -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Address<span class="text-blue-600">
              *</span></label>
          <textarea name="address" required
            class="w-full border border-gray-300 p-2 rounded-md focus:ring-2 focus:ring-blue-400"></textarea>
        </div>

        <!-- Plan Selection -->
        <!-- Plan Selection -->
        <div x-data="{ selectedPlan: null }" class="space-y-3">

          <label class="block text-sm font-medium text-gray-600">
            Select Plan <span class="text-blue-600">*</span>
          </label>

          <!-- GRID -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

            <template x-for="plan in [
      { code:'STARTER', name:'Strong Start Plan', duration:'1 Month', price:1, days:30 },
      { code:'FOCUS', name:'Focused Preparation Plan', duration:'3 Months', price:349, days:90, save:'22%' },
      { code:'HUSTLE', name:'Consistent Growth Plan', duration:'6 Months', price:649, days:180, popular:true, save:'28%' },
      { code:'SELECTION', name:'Final Selection Plan', duration:'12 Months', price:1199, days:365, best:true, save:'44%' }
    ]" :key="plan.code">

              <!-- CARD -->
              <div @click="selectedPlan = plan" :class="selectedPlan?.code === plan.code
          ? 'border-blue-600 ring-1 ring-blue-300 bg-blue-50'
          : 'border-gray-200 bg-white'" class="relative border rounded-xl p-4 cursor-pointer
               transition hover:shadow-sm">

                <!-- BADGE ROW (FIXED POSITION) -->
                <div class="absolute -top-2 right-2 flex gap-1">
                  <template x-if="plan.popular">
                    <span class="text-[10px] px-2 py-0.5 rounded-full bg-orange-500 text-white font-semibold">
                      Popular
                    </span>
                  </template>

                  <template x-if="plan.best">
                    <span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-600 text-white font-semibold">
                      Best Value
                    </span>
                  </template>
                </div>

                <!-- CONTENT -->
                <div class="flex flex-col gap-3">

                  <!-- PLAN TITLES -->
                  <div>
                    <h3 class="text-base font-semibold text-gray-800 leading-tight" x-text="plan.code"></h3>

                    <p class="text-xs text-gray-500 leading-snug" x-text="plan.name"></p>
                  </div>

                  <!-- PRICE ROW -->
                  <div class="flex items-end justify-between">
                    <p class="text-xs text-gray-600" x-text="plan.duration"></p>

                    <div class="text-right">
                      <p class="text-lg font-bold text-blue-700 leading-none">
                        ‚Çπ<span x-text="plan.price"></span>
                      </p>

                      <!-- SAVE % -->
                      <template x-if="plan.save">
                        <p class="text-[11px] text-green-600 font-medium">
                          Save <span x-text="plan.save"></span>
                        </p>
                      </template>
                    </div>
                  </div>

                </div>
              </div>
            </template>

          </div>

          <!-- HIDDEN INPUTS -->
          <input type="hidden" name="plan_code" :value="selectedPlan?.code">
          <input type="hidden" name="plan_name" :value="selectedPlan?.name">
          <input type="hidden" name="plan_duration" :value="selectedPlan?.duration">
          <input type="hidden" name="plan_price" :value="selectedPlan?.price">
          <input type="hidden" name="plan_days" :value="selectedPlan?.days">

        </div>

        <!-- Coupon Code -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">
            Have a Coupon?
          </label>

          <div class="flex gap-2">
            <input id="couponInput" type="text" placeholder="Enter coupon code" class="flex-1 border border-gray-300 p-2 rounded-md uppercase
             focus:ring-2 focus:ring-blue-400" />

            <button type="button" id="applyCouponBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md
             hover:bg-blue-700 transition">
              Apply
            </button>
          </div>

          <p id="couponMsg" class="text-sm mt-1"></p>
        </div>

        <!-- Price Preview -->
        <div id="pricePreview" class="hidden bg-blue-50 border rounded-lg p-3 text-sm">
          <div class="flex justify-between">
            <span>Original Price</span>
            <span id="originalPrice">‚Çπ0</span>
          </div>

          <div class="flex justify-between text-green-600">
            <span>Discount</span>
            <span>- ‚Çπ<span id="discountAmount">0</span></span>
          </div>

          <hr class="my-2">

          <div class="flex justify-between font-semibold text-blue-700">
            <span>Payable Amount</span>
            <span>‚Çπ<span id="finalAmount">0</span></span>
          </div>
        </div>


        <!-- Pay Button -->
        <button id="payBtn" type="button"
          class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-md font-semibold hover:scale-105 transition">
          Pay Now
        </button>

        <p id="successMsg" class="hidden text-green-600 text-center font-semibold mt-3">Successfully Enrolled!</p>
      </form>
    </div>

    <!-- Success Popup Modal -->
    <div id="successPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
      <div class="bg-white rounded-2xl p-8 text-center shadow-2xl max-w-sm w-full transform transition-all scale-100">
        <div class="flex justify-center mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-blue-500" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12l2 2l4-4m5 2a9 9 0 11-18 0a9 9 0 0118 0z" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-blue-600 mb-2">Congratulations!</h2>
        <p id="popupMessage" class="text-gray-700 mb-4">
          You have successfully enrolled!
        </p>
        <p class="text-sm text-gray-500">Redirecting you in 5 seconds...</p>
      </div>
    </div>
    <style>
      #successPopup[x-show="visible"] {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }

        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .animate-fadeIn {
        animation: fadeIn 0.4s ease-out;
      }
    </style>
  </main>

  <!-- Footer -->
  <footer class="bg-gradient-to-r from-blue-700 to-indigo-700 text-gray-100 py-5 mt-auto">
    <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
      <p class="mb-4 md:mb-0">&copy; 2025 Courage Library. All rights reserved.</p>
      <div class="flex space-x-6">
        <a href="https://www.facebook.com/people/Courage-Library/61561969000820/?mibextid=ZbWKwL" target="_blank"
          class="hover:text-white text-2xl"><i class="fab fa-facebook-f"></i></a>
        <a href="https://x.com/CourageLibrary" target="_blank" class="hover:text-white text-2xl"><i
            class="fab fa-twitter"></i></a>
        <a href="https://www.linkedin.com/company/courage-library" target="_blank" class="hover:text-white text-2xl"><i
            class="fab fa-linkedin-in"></i></a>
        <a href="https://www.instagram.com/couragelibrary1" target="_blank" class="hover:text-white text-2xl"><i
            class="fab fa-instagram"></i></a>
      </div>
    </div>
  </footer>

  <!-- Supabase -->
  <script>
    const SUPABASE_URL = "https://sgagswxzsxlgcspwiuoh.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnYWdzd3h6c3hsZ2NzcHdpdW9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NTA1NTIsImV4cCI6MjA2OTUyNjU1Mn0.ZNfk5WNDPkjKcFsRO48rEYk3dhbLYm_m21aZ-wfywo4";

    const supabaseClient = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_KEY
    );

    const payBtn = document.getElementById("payBtn");
    const form = document.getElementById("enrollForm");

    async function getCurrentUser() {
      const { data } = await supabaseClient.auth.getSession();
      if (!data.session) {
        alert("‚ö†Ô∏è Please login first.");
        window.location.href = "index.html?checkAuth=1";
        return null;
      }
      return data.session.user;
    }

    function resetPayButton() {
      payBtn.textContent = "Pay Now";
      payBtn.disabled = false;
    }

    payBtn.addEventListener("click", async () => {
      const popup = document.getElementById("successPopup");
      const popupMsg = document.getElementById("popupMessage");

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      if (!data.plan_code) {
        alert("‚ö†Ô∏è Please select a plan first.");
        return;
      }

      payBtn.textContent = "Processing...";
      payBtn.disabled = true;

      const user = await getCurrentUser();
      if (!user) {
        resetPayButton();
        return;
      }

      try {
        /* üîê CALL SUPABASE EDGE FUNCTION */
        const orderRes = await fetch(
          `${SUPABASE_URL}/functions/v1/create-razorpay-order`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "apikey": SUPABASE_KEY,
              "Authorization": `Bearer ${SUPABASE_KEY}`
            },
            body: JSON.stringify({
              plan_code: data.plan_code,
              coupon_code: appliedCoupon,
              preview: false
            })
          }
        );

        if (!orderRes.ok) {
          throw new Error("Failed to create payment order");
        }

        const order = await orderRes.json();

        /* üìÖ VALID TILL (FROM SERVER DAYS) */
        const today = new Date();
        const validTill = new Date(today);
        validTill.setDate(validTill.getDate() + order.plan_days);

        data.user_email = user.email;
        data.payment_status = "paid";
        data.valid_till = validTill.toISOString().split("T")[0];
        data.final_amount = order.amount;

        /* üí≥ RAZORPAY OPTIONS (SECURE ORDER) */
        const options = {
          key: "rzp_live_RdymXUT2ibglux",
          order_id: order.order_id,
          amount: order.amount * 100,
          currency: "INR",
          name: "Courage Library",
          description: `${data.plan_name} - ${data.course_name}`,
          image: "/images/logo.png",

          handler: async function (response) {
            try {
              data.payment_id = response.razorpay_payment_id;

              const { error } = await supabaseClient
                .from("student_enrollments")
                .insert([data]);

              if (error) {
                alert("‚ùå Enrollment failed: " + error.message);
                resetPayButton();
                return;
              }

              /* üìß SEND EMAIL (NON-BLOCKING) */
              fetch(
                `${SUPABASE_URL}/functions/v1/send-enrollment-email`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    email: data.user_email,
                    name: data.full_name,
                    course: data.course_name,
                    validTill: data.valid_till
                  })
                }
              ).catch(() => { });

              popupMsg.textContent =
                `Congratulations ${data.full_name}!
You are enrolled in ${data.plan_name}.
Valid till ${data.valid_till}.`;

              popup.classList.remove("hidden");
              popup.classList.add("flex", "animate-fadeIn");

              resetPayButton();

              setTimeout(() => {
                window.history.back();
              }, 3000);

            } catch (err) {
              console.error(err);
              alert("Something went wrong after payment.");
              resetPayButton();
            }
          },

          modal: {
            ondismiss: function () {
              alert("‚ö†Ô∏è Payment was not completed.");
              resetPayButton();
            }
          },

          prefill: {
            name: data.full_name,
            email: user.email,
            contact: data.phone
          },

          theme: { color: "#2563eb" }
        };

        const rzp = new Razorpay(options);
        rzp.open();

        rzp.on("payment.failed", function () {
          alert("‚ùå Payment Failed");
          resetPayButton();
        });

      } catch (err) {
        console.error(err);
        alert("‚ùå Unable to start payment");
        resetPayButton();
      }
    });

    const applyCouponBtn = document.getElementById("applyCouponBtn");
    const couponInput = document.getElementById("couponInput");

    const pricePreview = document.getElementById("pricePreview");
    const originalPriceEl = document.getElementById("originalPrice");
    const discountAmountEl = document.getElementById("discountAmount");
    const finalAmountEl = document.getElementById("finalAmount");

    let appliedCoupon = null;

    applyCouponBtn.addEventListener("click", async () => {
      const code = couponInput.value.trim();
      if (!code) return alert("Enter coupon code");

      const planCode = document.querySelector('[name="plan_code"]').value;
      if (!planCode) return alert("Select plan first");

      applyCouponBtn.textContent = "Checking...";
      applyCouponBtn.disabled = true;

      try {
        const res = await fetch(
          `${SUPABASE_URL}/functions/v1/create-razorpay-order`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "apikey": SUPABASE_KEY,
              "Authorization": `Bearer ${SUPABASE_KEY}`
            },
            body: JSON.stringify({
              plan_code: planCode,
              coupon_code: code,
              preview: true
            })
          }
        );

        const result = await res.json();

        if (!res.ok) {
          throw new Error("Invalid coupon");
        }

        // Show preview
        originalPriceEl.textContent = `‚Çπ${result.original_amount}`;
        discountAmountEl.textContent = result.discount;
        finalAmountEl.textContent = result.final_amount;

        pricePreview.classList.remove("hidden");
        appliedCoupon = code;

      } catch (err) {
        alert("‚ùå Invalid or expired coupon");
        pricePreview.classList.add("hidden");
        appliedCoupon = null;
      } finally {
        applyCouponBtn.textContent = "Apply";
        applyCouponBtn.disabled = false;
      }
    });

  </script>

</body>

</html>